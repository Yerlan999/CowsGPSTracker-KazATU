{% extends "my_pasture/master.html" %}

{% block title %}
  ГИС платформа ТОО "Северо-Казахстанская СХОС"
{% endblock %}


{% block content %}

<style>
    /* Custom CSS to change the color of carousel control icons */
    .carousel-control-prev-icon, .carousel-control-next-icon {
        background-color: #C7C7C7; /* Change to your desired color */
    }
    th {
        text-align: center;
        vertical-align: top;
    }

    #paddocks_bio_content {
      cursor: pointer;
    }

    /* Optional: Add some styling for better visibility */
    .section-header {
      padding: 20px;
      background-color: #e0e0e0;
      border: 1px solid #ccc;
    }
</style>


<!-- Prediction Modal -->
<div class="modal fade bd-example-modal-lg" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="myModalLabel">Расчет реальных значении</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
            <table class="table table-striped" id="mySampleTable">
            </table>
            <div class="row mt-3">
                <div class="col">
                    <input type="number" id="pixelValue" class="form-control" placeholder="Значение пикселя">
                </div>
                <div class="col">
                    <input type="number" id="realValue" class="form-control" placeholder="Реальный эквивалент (кг)">
                </div>
            </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="multiplyValues()">Рассчитать</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
        <button type="button" class="btn btn-success" id="switchToModalB" style="display:none">Симуляция</button>
      </div>
    </div>
  </div>
</div>


<!-- Simulation Modal -->
<div class="modal fade bd-example-modal-lg" id="myModalSim" tabindex="-1" role="dialog" aria-labelledby="myModalSimLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="myModalSimLabel">Симуляция стравливании на пастбище</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="modalBody">

        <h6 class="section-header">Раздел назначения дат сезона и выпаса КРС</h6>
        <hr>

          <div class="row">
            <div class="col">
                <div class="form-group">
                  <label for="seasonStart">Дата начала сезона</label>
                  <input type="date" class="form-control" id="seasonStart">
                </div>
            </div>
            <div class="col">
                <div class="form-group">
                  <label for="grazingStart">Дата начала выпаса</label>
                  <input type="date" class="form-control" id="grazingStart">
                </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
                <div class="form-group">
                  <label for="seasonEnd">Дата окончания сезона</label>
                  <input type="date" class="form-control" id="seasonEnd">
                </div>
            </div>
            <div class="col">
                <div class="form-group">
                  <label for="grazingEnd">Дата окончания выпаса</label>
                  <input type="date" class="form-control" id="grazingEnd">
                </div>
            </div>
          </div>


          <h6 class="section-header">Раздел симуляции КРС</h6>
          <hr>


            <div class="form-group">

              <div class="row">
                <div class="col">
                  <p class="text-center" for="count">Количество особей:</p>
                </div>
                <div class="col">
                  <input type="number" class="form-control" id="cattleCount">
                </div>
              </div>

              <div class="row">
                <div class="col">
                  <p class="mt-2">Пол особей:</p>
                  <select class="form-control" id="cattleSex">
                    <option>Случайный</option>
                    <option>Бычки</option>
                    <option>Коровы</option>
                  </select>
                </div>
                <div class="col">
                  <p class="mt-2">Порода особей:</p>
                  <select class="form-control" id="cattleBreed">
                    <option>Случайный</option>
                    <option>Angus</option>
                    <option>Hereford</option>
                    <option>Limousin</option>
                    <option>Charolais</option>
                  </select>
                </div>
              </div>


              <div class="row">
                <div class="col">
                  <p class="text-center mt-3">Диапазон возраста</p>
                </div>
                <div class="col">
                  <p class="text-center mt-3">Диапазон веса</p>
                </div>
              </div>


              <div class="row">
                <div class="col">
                  <label for="lowerAge">Нижнее значение:</label>
                  <input type="number" class="form-control" id="lowerAge">
                </div>
                <div class="col">
                  <label for="UpperAge">Верхнее значение:</label>
                  <input type="number" class="form-control" id="UpperAge">
                </div>
                <div class="col">
                  <label for="lowerWeight">Нижнее значение:</label>
                  <input type="number" class="form-control" id="lowerWeight">
                </div>
                <div class="col">
                  <label for="UpperWeight">Верхнее значение:</label>
                  <input type="number" class="form-control" id="UpperWeight">
                </div>
              </div>

            </div>


          <h6 class="section-header">Раздел симуляции растении</h6>
          <hr>

          <div class="row mb-3">
            <div class="col">
              <p class="">Название растения: </p>
            </div>
            <div class="col">
              <input type="text" class="form-control" id="plantName">
            </div>
            <div class="col">
              <button type="button" class="btn btn-success" onClick="appendElements();">Добавить растение</button>
            </div>
          </div>

          <div id="user_added_plants"></div>

          <div id="user_added_forms"></div>

          <h6 class="section-header mt-3" id="paddocks_bio_content">Раздел назначения ботанического состава загонов</h6>
          <hr>

          <div id="paddocks_bio_content_div"></div>


      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="switchToModalA">Назад</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
        <button type="button" class="btn btn-success" onclick="startSimulation()">Начать</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade bd-example-modal-lg" id="myHelperModal">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-body" style="max-height: 300px; overflow-y: auto;">
        <h3>Справка по составленю формул</h3>
        <hr>
        <h5>Доступные каналы:</h5>
        <hr>
        <p><a href="#" role="button" class="btn btn-info popover-test">ULTRA_BLUE</a> - канал в диапазоне [433-453] nm </p>
        <p><a href="#" role="button" class="btn btn-primary popover-test">BLUE</a> - канал в диапазоне [458-523] nm </p>
        <p><a href="#" role="button" class="btn btn-success popover-test">GREEN</a> - канал в диапазоне [543-578] nm </p>
        <p><a href="#" role="button" class="btn btn-danger popover-test" style="background-color: #e80e0e; border-color: #e80e0e;">RED</a> - канал в диапазоне [650-680] nm </p>
        <p><a href="#" role="button" class="btn btn-danger popover-test" style="background-color: #9e2121; border-color: #9e2121;">RED_EDGE1</a> - канал в диапазоне [698-713] nm </p>
        <p><a href="#" role="button" class="btn btn-danger popover-test" style="background-color: #9e2121; border-color: #9e2121;">RED_EDGE2</a> - канал в диапазоне [733-748] nm </p>
        <p><a href="#" role="button" class="btn btn-danger popover-test" style="background-color: #9e2121; border-color: #9e2121;">RED_EDGE3</a> - канал в диапазоне [773-793] nm </p>
        <p><a href="#" role="button" class="btn btn-danger popover-test" style="background-color: #570202; border-color: #570202;">NIR</a> - канал в диапазоне [785-900] nm </p>
        <p><a href="#" role="button" class="btn btn-danger popover-test" style="background-color: #ff6666; border-color: #ff6666;">N_NIR</a> - канал в диапазоне [855-875] nm </p>
        <p><a href="#" role="button" class="btn btn-warning popover-test" style="background-color: #366ecf; border-color: #366ecf;">WV</a> - канал в диапазоне [935-955] nm </p>
        <p><a href="#" role="button" class="btn btn-dark popover-test">SWIR_C</a> - канал в диапазоне [1360-1390] nm*. *Доступен только при выборе уровня L1C </p>
        <p><a href="#" role="button" class="btn btn-warning popover-test">SWIR_2</a> - канал в диапазоне [1565-1655] nm </p>
        <p><a href="#" role="button" class="btn btn-warning popover-test">SWIR_3</a> - канал в диапазоне [2100-2280] nm </p>
        <hr>
        <h5>Доступные функции:</h5>
        <hr>
        <p><a href="#" role="button" class="btn btn-secondary popover-test">mean(канал)</a> - функция позволяет рассчитать среднее значение канала</p>
        <p><a href="#" role="button" class="btn btn-secondary popover-test">median(канал)</a> - функция позволяет рассчитать медианное значение канала</p>
        <hr>
        <h5>Примеры составления формул:</h5>
        <hr>
        <p>mean(NIR) - (NIR - RED)</p>
        <p>NIR - median(NIR - RED)</p>
        <p>(NIR - RED) / (NIR + RED)</p>
        <hr>
        <h5>Более подробно о каналах можно узнать <a href="https://en.wikipedia.org/wiki/Sentinel-2" target="_blank" class="tooltip-test" title="Tooltip">здесь</a> и <a href="https://www.researchgate.net/publication/325209585/figure/tbl3/AS:667767116144642@1536219495031/Spectral-bands-and-resolutions-of-Sentinel-2-MSI-sensor.png" target="_blank" class="tooltip-test" title="Tooltip">здесь</a></h5>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
      </div>
    </div>
  </div>
</div>


<div class="container shadow-lg"><br>

    <h1 class="text-center">ГИС платформа ТОО "Северо-Казахстанская СХОС"</h1><br>
    <h3 class="text-center">Более подробная информация по выбранной дате</h3>

    <img class="img-fluid img-thumbnail" id="date_image" src="data:image/png;base64,{{ image_data }}" alt="Matplotlib Image">
    <div class="container mt-4">
      <div class="d-flex justify-content-center">
        <h5 class="text-center">Погодные данные</h5>
      </div>
      <div class="table-responsive">
          {{ weather_data|safe }}
      </div>
    </div>

    <h5 id="requested_date_image_header" class="text-center mt-3" hidden>Запрошенный индекс (канал)</h5>
    <img class="img-fluid img-thumbnail" id="requested_date_image" src="" alt="Requested Image" hidden>

    <h5 id="map_header" class="text-center mt-3" style="display: none">GPS треккинг КРС</h5>
    <div id="map" class="border border-success" style="height: 400px; width: 100%; display: none"></div>

    <h5 id="histograms_header" class="text-center mt-3" style="display: none">Гистограммы и таблица загонов </h5>
    <div id="carousel-container"></div>

    <table id="data-table" class="table table-striped" style="display: none;"> <!-- Initially hidden -->
        <thead class="thead-dark">
            <tr>
                <th class="text-left">Загон №</th>
                <th class="text-left">Сумма</th>
                <th class="text-left">Средняя</th>
                <th class="text-left">Медианная</th>
                <th class="text-left">Макс.</th>
                <th class="text-left">Мин.</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <button id="predict" type="button" class="btn btn-secondary btn-block" data-toggle="modal" data-target="#myModal" data-column3="Value 3" hidden onclick="disableSimulation()">Прогноз</button>

    <div id="myAlert" class="alert alert-danger alert-dismissible fade show mt-3 mb-3" role="alert" hidden="true">
    </div>

    <h5 class="text-center mt-5">Форма контроля параметров запроса</h5>
    <div class="input-group mb-3 mt-1">
      <span class="input-group-text" id="basic-addon1">f(к)=</span>
      <input id="formula" type="text" class="form-control" placeholder="Формула" aria-label="formula" aria-describedby="basic-addon1" data-toggle="tooltip" data-html="true" title="Для справки нажмите на кнопку '?' справа -> " data-placement="top">
      <button type="button" class="btn btn-secondary btn-sm" data-toggle="modal" data-target="#myHelperModal" style="width: 100px;">?</button>
    </div>



    <div class="row mt-3">
      <div class="col">
        <input type="checkbox" id="by_pasture" class="mr-2">
        <label for="by_pasture">Относительно пастбища</label>
      </div>
      <div class="col">
        <input type="checkbox" id="threshold_check" onclick="toggleThreshInput()" class="mr-2">
        <label for="threshold_check">Пороговое значение</label>
      </div>
      <div class="col">
        <select id="operators" class="form-select" aria-label="Оператор" disabled>
          <option selected>Оператор</option>
          <option value="==">==</option>
          <option value="<">&#60;</option>
          <option value="<=">&#8804;</option>
          <option value=">">&#62;</option>
          <option value=">=">&#8805;</option>
        </select>
      </div>
      <div class="col">
        <input type="number" id="threshold" class="form-control" disabled>
      </div>
    </div>


    <div class="row mt-3">
      <div class="col">
        <div class="form-check">
        <input class="form-check-input mr-2" name="flexRadioDefault" type="radio" id="relative_radio" checked onclick="disableBoundInputs()">
        <label for="relative_radio">Относительная шкала</label>
        </div>
      </div>
      <div class="col">
        <div class="form-check">
        <input class="form-check-input mr-2" name="flexRadioDefault" type="radio" id="absolute_radio" onclick="enableBoundInputs()">
        <label for="absolute_radio">Абсолютная шкала</label>
        </div>
      </div>
    </div>


    <div class="row mt-3">
      <div class="col">
        <input type="number" id="lower_bound" class="form-control"  placeholder="Нижняя грань" disabled>
      </div>
      <div class="col">
        <input type="number" id="upper_bound" class="form-control"  placeholder="Верхняя грань" disabled>
      </div>
    </div>


    <button class="btn btn-primary btn-lg btn-block mt-5 mb-5" id="ajax-button">Запрос</button>

</div>

<script>

    var paddocks_count = 0;

    $(document).ready(function() {
        $("#ajax-button").click(function() {

            var $button = $(this);
            var originalContent = $button.html();
            $button.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Запрос...');
            $button.attr('disabled', true);

            var formula = document.getElementById("formula").value;

            var by_pasture = document.getElementById("by_pasture").checked;

            var relative_radio = document.getElementById("relative_radio").checked;
            var absolute_radio = document.getElementById("absolute_radio").checked;

            var upper_bound = document.getElementById("upper_bound").value;
            var lower_bound = document.getElementById("lower_bound").value;

            var threshold_check = document.getElementById("threshold_check").checked;
            var threshold = document.getElementById("threshold").value;

            var operators = document.getElementById("operators").value;


            $.ajax({
                type: "GET",
                url: "/ajax/",
                data: {
                    'formula': formula,
                    'relative_radio': relative_radio,
                    'absolute_radio': absolute_radio,
                    'upper_bound': upper_bound,
                    'lower_bound': lower_bound,
                    'threshold_check': threshold_check,
                    'threshold': threshold,
                    'operators': operators,
                    'by_pasture': by_pasture,
                },
                success: function(data) {

                    if (data.index_image === null && data.df === null && data.hist_images === null){
                        $button.html(originalContent);
                        $button.attr('disabled', false);
                        setAlertText(false, "Ошибка при выполнении формулы");
                        return;
                    }
                    else{
                        setAlertText(true, "");
                        var preduct_button = document.getElementById("predict");
                        preduct_button.removeAttribute('hidden');
                    };

                    // Append the image element to the image container in the HTML
                    const requested_index = document.getElementById('requested_date_image');
                    const requested_index_header = document.getElementById('requested_date_image_header');
                    requested_index.src = `data:image/png;base64,${data.index_image}`;
                    requested_index.removeAttribute('hidden');
                    requested_index_header.removeAttribute('hidden');

                    var carouselContainer = $('<div id="image-carousel" class="carousel slide" data-ride="carousel"></div>');
                    var carouselIndicators = $('<ol class="carousel-indicators"></ol>');

                    var carouselInner = $('<div class="carousel-inner"></div>');

                    var prev_parentElement = $('<a class="carousel-control-prev" href="#image-carousel" role="button" data-slide="prev"></a>');
                    var prev_childElement1 = $('<span class="carousel-control-prev-icon" aria-hidden="true"></span>');
                    var prev_childElement2 = $('<span class="sr-only">Previous</span>');

                    // Append child elements to the parent element
                    prev_parentElement.append(prev_childElement1);
                    prev_parentElement.append(prev_childElement2);

                    var next_parentElement = $('<a class="carousel-control-next" href="#image-carousel" role="button" data-slide="next"></a>');
                    var next_childElement1 = $('<span class="carousel-control-next-icon" aria-hidden="true"></span>');
                    var next_childElement2 = $('<span class="sr-only">Next</span>');

                    // Append child elements to the parent element
                    next_parentElement.append(next_childElement1);
                    next_parentElement.append(next_childElement2);


                    data.hist_images.forEach(function(histogram, index) {

                        var carouselIndicator = $('<li style="background-color: #C7C7C7;" data-target="#image-carousel" data-slide-to="' + index + '"></li>');
                        var carouselItem = $('<div class="carousel-item"></div>');

                        if (index === 0) {
                            carouselIndicator.addClass('active');
                            carouselItem.addClass('active');
                        }

                        var imgElement = $('<img class="d-block w-100 img-thumbnail" src="data:image/png;base64,' + histogram + '">');
                        carouselItem.append(imgElement);

                        carouselIndicators.append(carouselIndicator);
                        carouselInner.append(carouselItem);

                    });

                    carouselContainer.append(carouselIndicators);
                    carouselContainer.append(carouselInner);

                    carouselContainer.append(prev_parentElement);
                    carouselContainer.append(next_parentElement);

                    // Add the carousel to the page
                    $('#carousel-container').empty();
                    $('#carousel-container').append(carouselContainer);
                    // $('#image-carousel').carousel();
                      $('#image-carousel').carousel({
                        interval: false
                      });

                    var tbody = $('#data-table tbody');
                    tbody.empty();

                    // Decode column names from UTF-8 encoding
                    var decodedData = JSON.parse(data.df);

                    // Iterate over the JSON data and populate the table
                    $.each(decodedData, function(index, row) {
                        var tr = $('<tr>');
                        tr.append('<td>' + row.Загон + '</td>');
                        tr.append('<td>' + row.Сумма + '</td>');
                        tr.append('<td>' + row.Cреднаяя + '</td>');
                        tr.append('<td>' + row.Медианная + '</td>');
                        tr.append('<td>' + row.Макс + '</td>');
                        tr.append('<td>' + row.Мин + '</td>');
                        tbody.append(tr);
                    });

                    // Show the table
                    $('#data-table').show();
                    $('#histograms_header').show();
                    // paddocks_count = document.getElementById('data-table').getElementsByTagName('tr').length - 2;

                    $button.html(originalContent);
                    $button.attr('disabled', false);



                    $('#map').show();
                    $("#map_header").show();

                    var existingMap = L.DomUtil.get('map');

                    if (existingMap) {
                      existingMap._leaflet_id = null;
                    }

                    var map = L.map('map').setView([data.centroid[1], data.centroid[0]], 15); // Set the initial map view

                    var googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
                            maxZoom: 20,
                            subdomains:['mt0','mt1','mt2','mt3']
                    });

                    // Add the default tile layer to the map
                    googleSat.addTo(map);


                    var marker = L.marker([0, 0])
                    .addTo(map)
                    .bindTooltip('Initial Tooltip', { permanent: false, opacity: 0.7 })

                      // Function to update marker position based on new data
                    function updateMarkerPosition(latitude, longitude, index, paddock_number) {
                        marker.setLatLng([latitude, longitude]);
                        marker.getTooltip().setContent('Номер КРС: ' + index + '<br>Номер загона: ' + paddock_number);
                    }


                    // Function to send the Ajax request
                    function sendAjaxRequest() {
                      $.ajax({
                          type: "GET",
                          url: "/ajax/",
                          data: {
                              'cow_number': 123
                          },
                          success: function(data) {
                          updateMarkerPosition(parseFloat(data.latitude), parseFloat(data.longitude), data.index, data.paddock_number);
                        },
                        error: function(xhr, status, error) {
                          console.error('Ajax request failed', status, error);
                        }
                      });
                    }

                    // Set the interval to send the Ajax request every 5 seconds (adjust as needed)
                    // setInterval(sendAjaxRequest, 10000); // 5000 milliseconds = 5 seconds




                    var geoJSONData = JSON.parse(data.geodataframe);
                    paddocks_count = geoJSONData.features.length -1;

                    var geoJsonLayer = L.geoJSON(geoJSONData, {
                      style: {
                        color: "green", // Polygon border color
                        weight: 1,      // Polygon border weight
                        fillOpacity: 0.2 // Polygon fill opacity (0 to 1)
                      },
                      onEachFeature: function (feature, layer) {
                        // Add mouseover event to highlight the shape and display information
                        layer.on('mouseover', function (e) {
                          var popupContent = "<b>Загон:</b> " + feature.properties.Загон + "<br><b>Сумма:</b> " + feature.properties.Сумма + "<br><b>Cреднаяя:</b> " + feature.properties.Cреднаяя + "<br><b>Медианная:</b> " + feature.properties.Медианная  + "<br><b>Макс:</b> " + feature.properties.Макс + "<br><b>Мин:</b> " + feature.properties.Мин;
                          layer.bindPopup(popupContent, { autoClose: false }).openPopup();
                          layer.setStyle({
                            color: 'red', // Highlighted border color
                            weight: 2       // Highlighted border weight
                          });
                        });

                        // Add mouseout event to reset the shape style
                        layer.on('mouseout', function (e) {
                          layer.closePopup();
                          geoJsonLayer.resetStyle(layer);
                        });
                      }
                    });

                    // Add the GeoJSON layer to the map
                    geoJsonLayer.addTo(map);


                    },
                error: function(error) {
                    console.error('Error:', error);
                    $button.html(originalContent);
                    $button.attr('disabled', false);
                }
            });
        });
    });


</script>


<script>

var table = document.getElementById('data-table');
var mySampleTable = document.getElementById('mySampleTable');
var predictModal = document.getElementById('predict');

// Add event listener to the modal to dynamically populate the column values
predictModal.addEventListener('click', function() {
  var columnNumber = 1; // Specify the column number you want to copy (starting from 0)

  mySampleTable.innerHTML = "";

  var sampleHeader = document.createElement('thead');
  sampleHeader.classList.add("thead-dark");
  var sampleHeaderRow = document.createElement('tr');
  var sampleHeaderTitle1 = document.createElement('th'); sampleHeaderTitle1.textContent = "Загон №";
  var sampleHeaderTitle2 = document.createElement('th'); sampleHeaderTitle2.textContent = "Cумма";
  var sampleHeaderTitle3 = document.createElement('th'); sampleHeaderTitle3.textContent = "Урожайность (т)";

  sampleHeaderRow.appendChild(sampleHeaderTitle1);
  sampleHeaderRow.appendChild(sampleHeaderTitle2);
  sampleHeaderRow.appendChild(sampleHeaderTitle3);

  sampleHeader.appendChild(sampleHeaderRow)

  var sampleBody = document.createElement('tbody');

  var rows = table.getElementsByTagName('tr');

  var realValue = $("#realValue").val();
  var pixelValue = $("#pixelValue").val();

  for (var i = 0; i < rows.length; i++) {

    var sampleTableRow = document.createElement('tr');

    var zagon = rows[i].getElementsByTagName('td')[0];
    var sum = rows[i].getElementsByTagName('td')[1];
    var new_sum = document.createElement('td'); new_sum.textContent = "";


    if (sum){

        sampleTableRow.appendChild(zagon.cloneNode(true));
        sampleTableRow.appendChild(sum.cloneNode(true));
        sampleTableRow.appendChild(new_sum);

        sampleBody.appendChild(sampleTableRow);
    }
  }
  mySampleTable.appendChild(sampleHeader);
  mySampleTable.appendChild(sampleBody);
});


var paddocks_resources = [];

function multiplyValues() {
  paddocks_resources.length = 0;
  var table = document.getElementById('mySampleTable');
  var realValue = document.getElementById('realValue').value;
  var pixelValue = document.getElementById('pixelValue').value;
  var rows = table.getElementsByTagName('tr');
  var nanDetected = false;

  for (var i = 0; i < rows.length; i++) {
    var cells = rows[i].getElementsByTagName('td');
    if (cells[1]){
      var value = parseFloat(cells[1].textContent);
      var multipliedValue = (value / pixelValue * realValue)/1000;
      if (isNaN(multipliedValue) || !isFinite(multipliedValue)){nanDetected=true;};
        cells[2].textContent = multipliedValue.toFixed(3);
        paddocks_resources.push(multipliedValue.toFixed(3))
    }
  }
  if (!nanDetected && realValue && pixelValue){$("#switchToModalB").show();};
}


  $(function () {
    $('[data-toggle="tooltip"]').tooltip();
  });


  function enableBoundInputs() {
    var upper_bound = document.getElementById("upper_bound");
    var lower_bound = document.getElementById("lower_bound");
    upper_bound.disabled = false;
    lower_bound.disabled = false;
  }

  function disableBoundInputs() {
    var upper_bound = document.getElementById("upper_bound");
    var lower_bound = document.getElementById("lower_bound");
    upper_bound.disabled = true;
    lower_bound.disabled = true;
  }

  function toggleThreshInput() {
    var threshold = document.getElementById("threshold");
    threshold.disabled = !threshold.disabled;
    var operators = document.getElementById("operators");
    operators.disabled = !operators.disabled;
  }


  // Function to set custom text in the alert
  function setAlertText(success, text) {
    var alertElement = document.getElementById('myAlert');
    if (success){
        if (alertElement) {
          // Set the custom text
          alertElement.innerHTML = text;
          // Show the alert
          alertElement.style.display = 'none';
          alertElement.hidden = true;
        }
    }
    else {
        if (alertElement) {
          // Set the custom text
          alertElement.innerHTML = text;
          // Show the alert
          alertElement.style.display = 'block';
          alertElement.hidden = false;
        }
    }
  }

  // Function to switch to Modal A
  $("#switchToModalA").click(function() {
    $("#myModalSim").modal("hide"); // Close Modal B
    $("#myModal").modal("show"); // Open Modal A
  });

  // Function to switch to Modal B
  $("#switchToModalB").click(function() {
    $("#myModal").modal("hide"); // Close Modal A
    $("#myModalSim").modal("show"); // Open Modal B
  });


    // Function to create options dynamically
    function createOptions(count) {
        let optionsHTML = '<option value=""></option>';
        for (let i = 1; i <= count; i++) {
            optionsHTML += `<option value="${i}">Загона №${i}</option>`;
        }
        return optionsHTML;
    }


    function createChecks(count, paddock) {
        let checksHTML = `
            <div class="form-group">
              <div class="row">
                <div class="col">
                    <label for="paddock_resource${paddock}">Ресурс загона (т)</label>
                </div>
                <div class="col">
                    <input type="number" class="form-control" id="paddock_resource${paddock}" placeholder="" value="${paddocks_resources[paddock-1]}">
                </div>
              </div>
            </div>
        `;

        for (let i = 0; i < count; i++) {

            checksHTML += `
                <div class="form-check mb-1">
                  <div class="row">
                    <div class="col">
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="checkbox" value="${added_plants_names[i]}" id="plantsOptions-${i}-${paddock}" onclick="myFunction(${i},${paddock})">
                          <label class="form-check-label">
                            ${added_plants_names[i]}
                          </label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-check form-check-inline">
                        <input type="number" class="form-control mr-1" id="percentage-${i}-${paddock}" placeholder="" disabled>%
                        </div>
                    </div>
                  </div>
                </div>
            `;
        }
        return checksHTML;
    }

    function myFunction(index, paddock){
      var enableCheckbox = document.getElementById('plantsOptions'+'-'+index+'-'+paddock);
      var numberInput = document.getElementById('percentage'+'-'+index+'-'+paddock);
      numberInput.disabled = !enableCheckbox.checked;
    }

  $("#paddocks_bio_content").click(function(){

    if (document.getElementById("paddocks_bio_content_div").innerHTML){
        document.getElementById("paddocks_bio_content_div").innerHTML = "";
    }
    else
    {
        var form = document.createElement("form");

        form.id = "PaddockNumber";
        form.style.display = "block";
        form.className = "border p-4";
        form.innerHTML = `

            <div class="form-group">
              <label for="paddock_number">Ботанический состав для: </label>
                <select id="paddock_number" class="form-select" aria-label="Default select example">
                  ${createOptions(paddocks_count)}
                </select>
            </div>

        `
        document.getElementById("paddocks_bio_content_div").appendChild(form);

        var selectElement = document.getElementById("paddock_number");
        selectElement.addEventListener("change", function() {
            // Get the selected value
            var selectedValue = selectElement.value;

            var paddocks_number = [];
            for (let i = 1; i < paddocks_count+1; i++) {
              paddocks_number.push(i);
            }

            var other_forms = paddocks_number.filter(element => element !== selectedValue);
            other_forms.forEach(form => $("#Paddock" + form).hide())

            $("#Paddock" + selectedValue).show();
        });


        for (let paddock = 1; paddock < paddocks_count+1; paddock++){
            var form = document.createElement("form");

            form.id = "Paddock" + paddock;
            form.style.display = "none";
            form.className = "border p-4";
            form.innerHTML = `

                ${createChecks(added_plants.length, paddock)}

            `
            document.getElementById("paddocks_bio_content_div").appendChild(form);

        }

    }
  });





  function disableSimulation(){
    $("#switchToModalB").hide();
  }


  var formCount = 0;
  var added_plants = [];
  var added_plants_names = [];

  // Function to append the elements to the modal body
  function appendElements() {

    if ($("#plantName").val().replace(/\s/g, '')){
        formCount++;
        added_plants.push(formCount);
        added_plants_names.push($("#plantName").val());

        // Create a button element to toggle the form
        var toggleButton = document.createElement("button");
        toggleButton.type = "button";
        toggleButton.id = "toggleButton" + formCount;
        toggleButton.className = "btn btn-success mr-1";
        toggleButton.textContent = $("#plantName").val();
        toggleButton.setAttribute("onClick", "toggleForm(" + formCount + ");");

        var deleteButton = document.createElement("button");
        deleteButton.type = "button";
        deleteButton.id = "deleteButton" + formCount;
        deleteButton.className = "btn btn-danger btn-block ml-1";
        deleteButton.textContent = "Удалить растение";
        deleteButton.setAttribute("onClick", "deleteForm(" + formCount + ");");

        var form = document.createElement("form");

        form.id = "form" + formCount;
        form.style.display = "none";
        form.className = "border p-4";
        form.innerHTML = `

            <div class="form-group">
              <label for="plant${formCount}">Название</label>
              <input type="text" class="form-control" id="plant${formCount}" value="${$("#plantName").val()}">
            </div>



              <div class="row">
                <div class="col">
                    <div class="form-group">
                      <label for="temperatureToleranceLower${formCount}">Нижняя неблагоприятная</label>
                      <input type="number" class="form-control" id="temperatureToleranceLower${formCount}" placeholder="">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                      <label for="temperatureToleranceIdeal${formCount}">Благоприятная темература</label>
                      <input type="number" class="form-control" id="temperatureToleranceIdeal${formCount}" placeholder="">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                      <label for="temperatureToleranceUpper${formCount}">Верхняя неблагоприятная</label>
                      <input type="number" class="form-control" id="temperatureToleranceUpper${formCount}" placeholder="">
                    </div>
                </div>
              </div>


              <div class="row">
                <div class="col">
                    <div class="form-group">
                      <label for="moistureToleranceLower${formCount}">Нижняя неблагоприятная</label>
                      <input type="number" class="form-control" id="moistureToleranceLower${formCount}" placeholder="">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                      <label for="moistureToleranceIdeal${formCount}">Благоприятная влажность</label>
                      <input type="number" class="form-control" id="moistureToleranceIdeal${formCount}" placeholder="">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                      <label for="moistureToleranceUpper${formCount}">Верхняя неблагоприятная</label>
                      <input type="number" class="form-control" id="moistureToleranceUpper${formCount}" placeholder="">
                    </div>
                </div>
              </div>



              <div class="row">
                <div class="col">
                    <div class="form-group">
                      <label for="radiationToleranceLower${formCount}">Нижняя неблагоприятная</label>
                      <input type="number" class="form-control" id="radiationToleranceLower${formCount}" placeholder="">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                      <label for="radiationToleranceIdeal${formCount}">Благоприятная радиация</label>
                      <input type="number" class="form-control" id="radiationToleranceIdeal${formCount}" placeholder="">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                      <label for="radiationToleranceUpper${formCount}">Верхняя неблагоприятная</label>
                      <input type="number" class="form-control" id="radiationToleranceUpper${formCount}" placeholder="">
                    </div>
                </div>
              </div>



            <!-- Peak dates and values -->
              <div class="row">
                <div class="col">
                    <div class="form-group">
                      <label for="firstPeak${formCount}">Дата пика №1</label>
                      <input type="date" class="form-control" id="firstPeak${formCount}">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                      <label for="max1Y${formCount}">Максимальное значение пика №1</label>
                      <input type="number" class="form-control" id="max1Y${formCount}" step="0.01">
                    </div>
                </div>
              </div>

              <div class="row">
                <div class="col">
                    <div class="form-group">
                      <label for="secondPeak${formCount}">Дата пика №2</label>
                      <input type="date" class="form-control" id="secondPeak${formCount}">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                      <label for="max2Y${formCount}">Максимальное значение пика №2</label>
                      <input type="number" class="form-control" id="max2Y${formCount}" step="0.01">
                    </div>
                </div>
              </div>


            <!-- Growth and Death Rate -->
              <div class="row">
                <div class="col">
                    <div class="form-group">
                      <label for="growthRate${formCount}">Темп роста (мм/день)</label>
                      <input type="number" class="form-control" id="growthRate${formCount}">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                      <label for="deathRate${formCount}">Темп отмирания (мм/день)</label>
                      <input type="number" class="form-control" id="deathRate${formCount}">
                    </div>
                </div>
              </div>


            <!-- Sigma and Plant Density -->
              <div class="row">
                <div class="col">
                    <div class="form-group">
                      <label for="sigma${formCount}">Сигма</label>
                      <input type="number" class="form-control" id="sigma${formCount}">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                      <label for="plantDensity${formCount}">Плотность растения</label>
                      <input type="number" class="form-control" id="plantDensity${formCount}">
                    </div>
                </div>
              </div>
        `;
        // Append the toggleButton and form to the modal body
        document.getElementById("user_added_plants").appendChild(toggleButton);
        form.appendChild(deleteButton);
        document.getElementById("user_added_forms").appendChild(form);
        document.getElementById('plantName').value = '';
      }
    }


  // Function to toggle a specific form
  function toggleForm(formId) {
    $("#form" + formId).toggle();
    const other_forms = added_plants.filter(element => element !== formId);
    other_forms.forEach(form => $("#form" + form).hide())
  }

  function deleteForm(formId) {
    $("#form" + formId).remove();
    $("#toggleButton" + formId).remove();
    $("#deleteButton" + formId).remove();
    $("#breakDiv" + formId).remove();

    var indexToRemove = added_plants.indexOf(formId);
    if (indexToRemove !== -1) {
      added_plants.splice(indexToRemove, 1);
      added_plants_names.splice(indexToRemove, 1);
    };

  }



function startSimulation() {
    var inputData = {};
    var modalBody = document.querySelector('#modalBody');

    var inputElements = modalBody.querySelectorAll('input');
    var selectElements = modalBody.querySelectorAll('select');

    selectElements.forEach(function (select) {
      var selectedOption = select.options[select.selectedIndex];
      if (select.id != "paddock_number"){
          inputData[select.id] = selectedOption.value;
      }

    });

    inputElements.forEach(function (input) {
      inputData[input.id] = input.value;
    });

    inputData["plants_count"] = added_plants_names.length;
    inputData["paddocks_count"] = paddocks_count;

    var serializedData = JSON.stringify(inputData);

    $.ajax({
      type: "GET",
      url: "/ajax/",
      data: {
          'simulation_data': serializedData
      },
      success: function(data) {
      console.log(data)
      },
      error: function(xhr, status, error) {
      console.error('Ajax request failed', status, error);
        }
    });

}



</script>


{% endblock %}
